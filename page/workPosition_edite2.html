<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>分店管理-设置</title>
	<link rel="stylesheet" href="../js/plugin/layui-v2.3.0/layui/css/layui.css">
	<link rel="stylesheet" href="../css/reset.css">
	<link rel="stylesheet" href="../css/index.css">
	<link rel="stylesheet" href="../css/workpos.css">
	<!-- <link rel="stylesheet" href="../css/set.css"> --> 
	<script src="../js/jquery-2.1.1.min.js"></script>
	<link rel="stylesheet" href="../css/workpos.css">
	<script src="../js/plugin/layui-v2.3.0/layui/layui.js"></script>
</head>
<style>
 ::-webkit-scrollbar-thumb {
  background:#a2a2a2; 
  border-radius: 10px;
  height:50%;
}
::-webkit-scrollbar{width:6px;}
	body{
		overflow-y: scroll;
	}
.all-chart .chart-box {
    margin-right: 10px !important;
} 
</style>
<body>
<div class="kb-out-box">
	<div class="svg-wrap-edit">
		<header class="head-bar flex-between">
			<div class="bar-left flex">
				<div class="flex-vcenter">
					<i class="upload_icon"></i>
					<span> 上传</span>
				</div>
				<div class="flex-vcenter">
					<i class="open_icon"></i>
					<span> 打开</span>
				</div>
			</div>
			<div class="bar-right flex"> 
				<div class="flex-vcenter bar-btn" id='square-btn'>
					<i class="square_icon"></i>
					<span>正方形</span>
				</div>
				<div class="flex-vcenter bar-btn" id="line-btn">
					<i class="broken_line_icon"></i>
					<span> 折线图</span>
				</div>
				<div class="flex-center" id="change-size">
					<i class="add_icon"></i>
					<span class="percent-txt">100%</span>
					<i class="reduce_icon"></i>
				</div>
				<div class="flex-vcenter">
					<i class="close_icon"></i>
					<span> 关闭</span>
				</div>
			</div>
		</header>
		<div class="svg-tool">
			<div class="tool-content">
				<div class="layui-tab layui-tab-brief" style="height: 100%">
					<ul class="layui-tab-title" id="partitionState">
					    <li class="layui-this">分区</li>
					    <li value="1">工位</li>
					</ul>
					<div class="layui-tab-content" style="height: 100%">
						<div>
							<button class="layui-btn layui-btn-normal btn-bg" id="" lay-filter="formEmployee" lay-submit="" style="width: 180px">创建分区</button>
						</div>
						<div class="areaList_container mag-top-20" id="areaList_container">
							<!-- <div class="flex-between" style="padding: 5px 10px; cursor: pointer;">
								<span class="t-over" style="max-width: 90px;">头等舱 </span>
								<div class="block-relation flex-center"><i class="layui-icon layui-icon-share"></i><span>取消关联</span>
								</div>
							</div>
							<div class="flex-between" style="padding: 5px 10px; cursor: pointer;">
								<span class="t-over" style="max-width: 90px;">头等舱 </span>
								<div class="block-relation flex-center"><i class="layui-icon layui-icon-share"></i><span>取消关联</span>
								</div>
							</div>
							<div class="flex-between" style="padding: 5px 10px; cursor: pointer;">
								<span class="t-over" style="max-width: 90px;">头等舱 </span>
								<div class="block-relation flex-center"><i class="layui-icon layui-icon-share"></i><span>取消关联</span>
								</div>
							</div> -->
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="svg-detail">
			<div style="height: 100%;padding: 10px;" id="area_details">
				<!-- <div class="m-updown">
					<button class="layui-btn layui-btn-normal btn-bg" id="" lay-filter="formEmployee" lay-submit="" style="width: 180px">编辑分区</button>
				</div>
				<div class="flex-between" style="padding: 5px 10px;">
					<span>名称：</span><span>头等舱 </span>
				</div>
				<div class="flex-between " style="padding: 5px 10px;">
					<span>类型：</span><span>头等舱 </span>		
				</div>
				<div class="flex-between " style="padding: 5px 10px;">
					<span>工位数：</span><span>头等舱 </span>
				</div>
				<div class="flex-between " style="padding: 5px 10px;">
					<span>容纳人数：</span><span>头等舱 </span>
				</div>
				<div class="flex-between " style="padding: 5px 10px;">
					<span>面积：</span><span>头等舱 </span>
				</div>
				<div class="flex-between " style="padding: 5px 10px;">
					<span>锁：</span><span>头等舱 </span>
				</div>
				<div class="flex-between " style="padding: 5px 10px;">
					<span>墙：</span><span>头等舱 </span>	
				</div>
				<div class="flex-between " style="padding: 5px 10px;">
					<span>朝向：</span><span>头等舱 </span>	
				</div> -->
			</div>
		</div>
		<div class="svg-editor">
			<div class="svg-content">
				<div class="svg-wrap" style="display: inline-block;">
					<svg class="kb-fp-svg" id="svg-box" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="width: 888px; height: 420.932px;">
						<g> 
				            <image id="raster" height="100%" width="100%" xlink:href="../images/plan.png" style="opacity: 0.5;"></image>
				            <rect width="100%" height="100%" style="fill: rgb(240, 240, 240);opacity: 0.5;"></rect>
				        </g>
					</svg>
				</div>
				
			</div>
		</div>
		

	</div>
</div>
</body>
<script>
//M10.105675675675675 324.145 L10.105675675675675 370.5899099099099 L119.18396396396398 370.5899099099099 L119.18396396396398 324.145  Z
//
var pathAllSize=[];
$(function(){
	parent.setLayBody();//隐藏头部导航
	var svgNS="http://www.w3.org/2000/svg";
	var svgLeft=$(".svg-wrap")[0].offsetLeft*1-200;//画布据浏览器的左边距离
	var svgTop=$(".svg-wrap")[0].offsetTop*1+7;//画布距浏览器的上部距离

	window.onresize=function(){
	 svgLeft=$(".svg-wrap")[0].offsetLeft;
	 svgTop=$(".svg-wrap")[0].offsetTop;
	}  
	//注意：折叠面板 依赖 element 模块，否则无法进行功能性操作
	layui.use(['element','layer'], function(){
	  var element = layui.element;
	  var layer=layui.layer;
	  //…
	});


	
	//var fleg=true;//用来判断页面是否存在四个方块
	var elementSvg= document.getElementById('svg-box');
	var currentPath=null;//绘制的当前的四个方块的path对象,也是点击时的高亮path；
	var pathAll=document.getElementsByTagName('path');
	var squareFleg=false,lineFleg=false;//判断是否点击头部工具条;
	var newArr=[];//点击高亮时的path的路径
    var rectArr=[];//点击高亮动态生成的rect的路径
	//列表的点击事件，显示详情信息
	$('#areaList_container').on("click",".list",function(){
		$('#areaList_container .list').removeClass('active');
		$(this).addClass("active");//点击的高亮
		var dataA=JSON.parse($(this).attr("data-area"));
		var id=$(this).attr("data-id");
		renderSide(dataA,$("#area_details"))//渲染右侧的信息详情
		clearRect(elementSvg);
		findIdPath(id,newArr,rectArr,currentPath)//对应的path高亮；
	})

	//渲染svg--PATH块的区域
	runAsync('../data/areaPath.json').then(function(data){
		var pathD=data;
		renderPath(pathD,$("#svg-box")[0])//渲染path

		//path鼠标点下
		$('#svg-box .path').on('mousedown',function(event){
			
			preventBubble(event);
			clearRect(elementSvg)
	        newArr=[];rectArr=[];//每次点击情况高亮path和高亮rect的存在数组里面的值;
	        var target=$(this);
	        	id=$(target).attr("data-id");
	       		currentPath=target[0];//点击时的高亮path
	        var gParent=$(this).parent()[0];//path的父亲g； 
	        newArr=getDfn($(this)[0])
	        //创建四个方块；
	        if(createRcetFleg(target[0])){
	          createRect(gParent,newArr,currentPath,rectArr,elementSvg);

	        }
	        target[0].setAttribute("fill",'rgb(185, 217, 245)');//移动时的蓝色高亮
	        findIDList(id)//点击path对应的左侧列表高亮
	        //位置
	        var mouseX=event.clientX;
	        var mouseY=event.clientY;//计算xy
	        var nodeRect=$(target).parent().next().children();
	        for(var m=0;m<nodeRect.length;m++){
	          rectArr.push(getXY(nodeRect[m]));
	        }

	        //移动
	        var chax=0,chay=0;
	        elementSvg.onmousemove=function(event){
	          var newX=event.clientX;chax=(newX-mouseX)*1;
	          var newY=event.clientY;chay=(newY-mouseY)*1;
	          var strAttr='';
	          for(var n=0;n<newArr.length/2;n++){
	             var x=newArr[n*2]*1+chax;
	            var y=newArr[n*2+1]*1+chay;
	            setXY(nodeRect.eq(n)[0],(rectArr[n]["x"]*1+chax),(rectArr[n]["y"]*1+chay))
	            if(n==0){
	               strAttr="M"+x+" "+y+" ";
	            }else{
	              strAttr+="L"+x+" "+y+" ";
	            }
	          }
	          strAttr+="Z";
	         $(target)[0].setAttribute("d", strAttr);

	         }
	        //抬起
	        elementSvg.onmouseup=function(event){
	           elementSvg.onmousemove=null;
		       elementSvg.onmouseup=null;
		       pathAllSize.length=0;//保证重新获取所有的path（包括新添加的，为了缩放功能）
		       //抬起的时候存储信息；
	          for(var m=0;m<newArr.length/2;m++){
	            newArr[m*2]=newArr[m*2]*1+chax;
	            newArr[m*2+1]=newArr[m*2+1]*1+chay;
	            rectArr[m]["x"]=rectArr[m]["x"]*1+chax;
	            rectArr[m]["y"]=rectArr[m]["y"]*1+chay;
	          }
	        }
		})

	})
	//点击其他地方方块消失；
	var addFleg=true;
	elementSvg.onmousedown=function(event){
		console.log('svg-down')
		clearRect(elementSvg);
	    rectArr=[];//清除方块后清空
		var mouseX=event.clientX;
		var mouseY=event.clientY;//计算xy
		//获取鼠标起始在svg上的点坐标；（startX，startY）;
		var startX=mouseX-svgLeft;
		var startY=mouseY-svgTop;
		
	    //点击头部正方形，绘画方块；
	    if(squareFleg){
	    	//画方块时创建对象g和path；
	    	currentPath=null;
			var squareG=document.createElementNS(svgNS,"g");
			var squarePath=document.createElementNS(svgNS,"path");
			currentPath=squarePath;
		      bindEvent(squarePath,"mousedown",function(e){
		        	preventBubble(e);
		        	 rectArr=[];currentPath=null;newArr=[];//清除方块后清空
					currentPath=squarePath;
		        	newPathDown(squarePath,e,elementSvg,newArr,rectArr,currentPath);
		        	lineFleg=false;squareFleg=false;
		        	$('#square-btn').removeClass('active');
		        	$('.svg-content').removeClass('dreg-content');//在画布上去除的十字架
		      });
		      elementSvg.onmousemove=function(event){
		        //获取结束的坐标点；（endX，endY）
		        var endX=event.clientX-svgLeft;
		        var endY=event.clientY-svgTop;
		        var pathD="M"+startX+" "+startY+" L"+endX+" "+startY+" L"+endX+" "+endY+" L"+startX+" "+endY+" Z";
		        newArr=[startX,startY,endX,startY,endX,endY,startX,endY];//存储当前绘画的path路径;
		        squarePath.setAttribute("d",pathD);//M12.51 80.01 L68.34 80.01 L68.34 10.86 L12.51 10.86  Z
		        squarePath.setAttribute("fill","rgba(119,206,235,0.6)");
		        squarePath.setAttribute("class","path");
		        squareG.appendChild(squarePath);
		        elementSvg.appendChild(squareG);

		      };
		      //画方块时的抬起；
		      elementSvg.onmouseup=function(event){
		        elementSvg.onmousemove=null;
		        elementSvg.onmouseup=null;			
				//创建四个方块；
		        if(createRcetFleg(squarePath)){
		          createRect(squareG,newArr,currentPath,rectArr,elementSvg);
		        } 
		        pathAllSize.length=0;//保证重新获取所有的path（包括新添加的，为了缩放功能）
		      }
	    }
	    //点击头部的折线，绘画不规则图形
	    if(lineFleg){
	    	newArr.push(startX);
			newArr.push(startY);
		    var pathD='M';
	       for(var m=0;m<newArr.length/2;m++){
	       		pathD+=newArr[m*2]+" "+ newArr[m*2+1]+" ";
	       }
	       pathD+="Z";
	    	if(addFleg){
		    	var squareG=document.createElementNS(svgNS,"g");
				var squarePath=document.createElementNS(svgNS,"path");
				currentPath=squarePath;
		    	//画line不规则的图像时；
		    	 bindEvent(squarePath,"mousedown",function(e){
			        	preventBubble(e);
			        	rectArr=[];currentPath=null;newArr=[];//清除方块后清空
						currentPath=squarePath;
			        	newPathDown(squarePath,e,elementSvg,newArr,rectArr,currentPath);
			        	$('#square-btn').removeClass('active');
			        	$('.svg-content').removeClass('dreg-content');//在画布上去除的十字架
			        	lineFleg=false;
			      });
		       currentPath.setAttribute("d",pathD);//M12.51 80.01 L68.34 80.01 L68.34 10.86 L12.51 10.86  Z
		       squarePath.setAttribute("fill","rgba(119,206,235,0.6)");
			   squarePath.setAttribute("class","path");
			   squareG.appendChild(squarePath);
			   elementSvg.appendChild(squareG);
			   pathAllSize.length=0;//保证重新获取所有的path（包括新添加的，为了缩放功能）
			   addFleg=false;
			   return false;
			}
	       currentPath.setAttribute("d",pathD);//M12.51 80.01 L68.34 80.01 L68.34 10.86 L12.51 10.86  Z
			
	    }
    	
	   
	}     



	//渲染左侧的列表区域
	runAsync("../data/area.json").then(function(data){
		data.sort(function (a,b){
			return a.id-b.id  
		});
		var areaDate=data;
		var areaList="";
	　　for(var i=0;i<areaDate.length;i++){
			var colorBg="#b6b7b8",tit="关联"
			if(areaDate[i]["lock"]){
				colorBg='#78c83c';
				tit="取消关联";
			}
			areaList+=`<div class="flex-between list" style="padding: 5px 10px; cursor: pointer;" data-id="`+areaDate[i]["id"]+`" data-area='`+ JSON.stringify(areaDate[i])+`'>`
							+`<span class="t-over" style="max-width: 90px;">`+areaDate[i]["name"]+` </span>`
							+`<div class="block-relation flex-center" style="background-color:`+colorBg+`"><i class="layui-icon layui-icon-share"></i><span>`+tit+`</span>`
							+`</div>`
						+`</div>`
		};
		$('#areaList_container').html(areaList);
	});

	//正方形按下的画画
	  $('#square-btn').on("click",function(){
	  	clearRect(elementSvg);
	  	rectArr=[];currentPath=null;newArr=[];//清除方块后清空
	  	$(".bar-btn").removeClass('active');
	    $(this).addClass('active');
	    $('.svg-content').addClass('dreg-content');//在画布上移动的十字架
	    squareFleg=true;lineFleg=false;
	    
	  })

	//折线按下
	  $("#line-btn").on("click",function(){
	  	clearRect(elementSvg);
	  	rectArr=[];currentPath=null;newArr=[];addFleg=true;//清除方块后清空,画不规则的启动
	  	$(".bar-btn").removeClass('active');
	  	$(this).addClass('active');
	  	$('.svg-content').addClass('dreg-content');//在画布上移动的十字架
	  	lineFleg=true;squareFleg=false;

	  })
	//监听删除事件
	  $(document).keydown(function(event){
	　　var code=event.keyCode;addFleg=true;
		if(code==46){
			$(currentPath).parent('g').next("g").remove();
			$(currentPath).parent('g').remove();
		}
	　});
	 //改变缩放的大小
	 var sizeN=100;var precontNum=1;
	 var width=$('#svg-box').width()*1,height=$('#svg-box').height()*1;
	 $('#change-size').on("click","i",function(){
	 	clearRect(elementSvg);//缩放的时候清空小rect四方快
	 	var targetI=$(this);
	 	if(targetI.hasClass('add_icon')){
	 		sizeN+=10;
	 	}else{
	 		sizeN <=10?  sizeN=10 : sizeN-=10;
	 	}
	 	precontNum=sizeN/100;
	 	$('.percent-txt').text(sizeN+'%');
	 	$('#svg-box').css({
	 		'width':width*precontNum,
	 		'height':height*precontNum
	 	})
		 svgLeft=$(".svg-wrap")[0].offsetLeft;//重新获取边距
		 svgTop=$(".svg-wrap")[0].offsetTop;
		setZoom(elementSvg,precontNum)
	 })

})
//首次进来渲染左侧菜单点击的详情
function renderSide(dataA,ele){
	var strD=`<div class="m-updown">`
					+`<button class="layui-btn layui-btn-normal btn-bg" id="" lay-filter="formEmployee" lay-submit="" style="width: 180px">编辑分区</button>`
				+`</div>`;
				strD+=`<div class="flex-between" style="padding: 5px 10px;">`
							+`<span>名称：</span><span>`+dataA['name']+` </span>`
						+`</div>`
						+`<div class="flex-between " style="padding: 5px 10px;">`
							+`<span>类型：</span><span>`+dataA['area_type']+` </span>`		
						+`</div>`
						+`<div class="flex-between " style="padding: 5px 10px;">`
							+`<span>工位数：</span><span>`+dataA['capacity'] +`</span>`
						+`</div>`
						+`<div class="flex-between " style="padding: 5px 10px;">`
							+`<span>容纳人数：</span><span>`+dataA['real_capacity'] +`</span>`
						+`</div>`
						+`<div class="flex-between " style="padding: 5px 10px;">`
							+`<span>面积：</span><span>`+dataA['size'] +` ㎡</span>`
						+`</div>`
						+`<div class="flex-between " style="padding: 5px 10px;">`
							+`<span>锁：</span><span>`+dataA['lock'] +` </span>`
						+`</div>`
						+`<div class="flex-between " style="padding: 5px 10px;">`
							+`<span>墙：</span><span>`+dataA['lock'] +` </span>`	
						+`</div>`
						+`<div class="flex-between " style="padding: 5px 10px;">`
							+`<span>朝向：</span><span>南 </span>`	
						+`</div>`
		$(ele).html(strD)
}
//首次进来渲染path
function renderPath(dataArea,svg){	
	var svgNS="http://www.w3.org/2000/svg";
	for(var j=0;j<dataArea.length;j++){
		if(!dataArea[j]['path']){
			continue;
		}
		var g=document.createElementNS(svgNS,"g");
		var pathNode=document.createElementNS(svgNS,"path");
		pathNode.setAttribute("data-id",dataArea[j]['id']);
		pathNode.setAttribute("class",'path');
		pathNode.setAttribute("d",dataArea[j]['path']);
        pathNode.setAttribute("fill",'rgba(120, 200, 60, 0.3)');
        pathNode.setAttribute("stroke",'rgb(185, 217, 245)');
        var name=dataArea[j]['name'];
       (function(name){
       		 bindEvent(pathNode,"mouseover",function(event){
	        	var e=e||event;
	        	var path=e.target;
	        	setHover(path,name);
	        });
       })(name)
        bindEvent(pathNode,"mouseout",removeHover);
       /* bindEvent(pathNode,"mousedown",pathDown)*/
        g.appendChild(pathNode);
        svg.appendChild(g);
	}	
}
function setHover(path,name){
	var str="<p>"+name+"</p>"
	layer.tips(str, path, {
	  tips: [1, '#000'] //还可配置颜色
	});
	path.setAttribute("fill",'rgba(120, 200, 60, 0.9)');
};
function removeHover(){
	this.setAttribute("stroke-width",'');
	this.setAttribute("fill",'rgba(120, 200, 60, 0.3)');
	layer.closeAll()
	// 事件绑定
}
function newPathDown(newPath,e,elementSvg,newArr,rectArr,currentPath){
	console.log('newPathDown')
	clearRect(elementSvg);
	newArr=[];rectArr=[];//每次点击情况高亮path和高亮rect的存在数组里面的值;
	//创建四个方块；
	var gParent=$(newPath).parent();
	    newArr=getDfn(newPath)
    if(createRcetFleg(newPath)){
      createRect(gParent[0],newArr,currentPath,rectArr,elementSvg);
    }
	var nodeRect=$(newPath).parent().next().children();
    for(var m=0;m<nodeRect.length;m++){
      rectArr.push(getXY(nodeRect[m]));
    }
	//位置
    var mouseX=event.clientX;
    var mouseY=event.clientY;//计算xy
    //移动
    elementSvg.onmousemove=function(event){
		var newX=event.clientX,chax=(newX-mouseX)*1;
		var newY=event.clientY;chay=(newY-mouseY)*1;
		var strAttr='';
		for(var n=0;n<newArr.length/2;n++){
		 var x=newArr[n*2]*1+chax;
		var y=newArr[n*2+1]*1+chay;
		setXY(nodeRect.eq(n)[0],(rectArr[n]["x"]*1+chax),(rectArr[n]["y"]*1+chay))
			if(n==0){
			   strAttr="M"+x+" "+y+" ";
			}else{
			  strAttr+="L"+x+" "+y+" ";
			}
		}
		strAttr+="Z";
		newPath.setAttribute("d", strAttr);
     }
    //抬起
    elementSvg.onmouseup=function(event){
     	elementSvg.onmousemove=null;
        elementSvg.onmouseup=null;
         pathAllSize.length=0;//保证重新获取所有的path（包括新添加的，为了缩放功能）
        //清空重新储存，解决移动后，点击四方快会错位的问题；
        clearRect(elementSvg);
		newArr=[];rectArr=[];
      newArr=getDfn(currentPath)
      if(createRcetFleg(newPath)){
	      createRect(gParent[0],newArr,currentPath,rectArr,elementSvg);
	   }
      var nodeRect=$(currentPath).parent().next().children();
      for(var m=0;m<nodeRect.length;m++){
          rectArr.push(getXY(nodeRect[m]));
      }
    }
	return false;
}
//点击path对应的左侧列表高亮
function findIDList(id){
	var list=$("#areaList_container .list");
    for(var k=0;k<list.length;k++){
    	var dataId=$(list[k]).attr("data-id");
    	$(list[k]).removeClass('active')
    	if(dataId==id){
    		$(list[k]).addClass('active')
    	}
    }
}
function findIdPath(id,newArr,rectArr,currentPath){
	var ArrPath=$("#svg-box .path");
	for(var n=0;n<ArrPath.length;n++){
		var path=ArrPath[n];
		var dataId=$(ArrPath[n]).attr("data-id");
		if(dataId==id){
			var gParent=$(path).parent()[0];//path的父亲g； 
			newArr=getDfn(path);
			//创建四个方块；
	        if(createRcetFleg(path)){
	          createRect(gParent,newArr,currentPath,rectArr,elementSvg);
	        }
		}
	}
}
//创建四个rect一个g,obj指path的父亲g;
//arr---->newArr;
//["12.51", "80.01", "68.34", "80.01", "68.34", "10.86", "12.51", "10.86", ""]
function createRect(obj,newArr,currentPath,rectArr,elementSvg){
  var svgNS="http://www.w3.org/2000/svg";
 rectArr=[];
  var g=document.createElementNS(svgNS,"g");
    for(var j=0;j<newArr.length/2;j++){
      var nodeRect= document.createElementNS(svgNS,"rect");
      nodeRect.setAttribute("height",8);
      nodeRect.setAttribute("width",8);
      nodeRect.setAttribute("x",newArr[j*2]-4);
      nodeRect.setAttribute("y",newArr[j*2+1]-4);
      nodeRect.setAttribute("class","fp-tool-rect kb-cursor-edite");

      rectArr.push({"x":newArr[j*2]-4,"y":newArr[j*2+1]-4});//画的就是高亮的，存储高亮的数据；
      (function(nodeRect){
      	bindEvent(nodeRect,"mousedown",function(event){
	      	preventBubble(event);
	      	rectMoveSet(nodeRect,rectArr,newArr,currentPath,event,elementSvg)//点击小方块的时候，修改图形
	    })
      })(nodeRect)
      g.appendChild(nodeRect);
    }
    var svgParent = obj.parentNode;//获取该g的父节点svg；
    var next = obj.nextSibling;//获取g的下一个兄弟节点
    //判断兄弟节点是否存在
    if(next) {
        //存在则将新节点插入到div的下一个兄弟节点之前，即g之后
        svgParent.insertBefore(g,next);
    } else {
        //console.log(svgParent)
        //不存在则直接添加到最后,appendChild默认添加到svgParent的最后
        svgParent.appendChild(g);
    }
    return false;
}
//点击设置方块的移动修改图形,
function rectMoveSet(nodeRect,rectArr,newArr,currentPath,event,elementSvg){
	var index=getChildrenIndex(nodeRect);
	//位置
	var startX=event.clientX,
		startY=event.clientY;
	var pathx=newArr[index*2],pathy=newArr[index*2+1];
	var rectx=pathx-4,recty=pathy-4;
	 //移动
    elementSvg.onmousemove=function(event){
    	//console.log(rectx,recty,'k');
    	//修改高亮的rect：rectArr 和 高亮的path路径：newArr;
		var newX=event.clientX,chax=(newX-startX)*1;
		var newY=event.clientY,chay=(newY-startY)*1;
		nodeRect.setAttribute("x",rectx*1+chax);
        nodeRect.setAttribute("y",recty*1+chay);
        rectArr[index]["x"]=rectx*1+chax;
        rectArr[index]["y"]=recty*1+chay;
        var pathD='M';
		for(var m=0;m<newArr.length;m++){//设置path'的修改
			if(m==index*2){
	       		newArr[m]=pathx*1+chax;
	       	}else if(m==index*2+1){
	       		newArr[m]=pathy*1+chay;
	       	}
		}
       for(var m=0;m<newArr.length/2;m++){//拼接path的d；
	        if(m==0){	
       			pathD+=newArr[m*2]+" "+ newArr[m*2+1]+" ";
       		}else{
       			pathD+="L"+newArr[m*2]+" "+ newArr[m*2+1]+" ";
       		}
       }
       pathD+="Z";
     currentPath.setAttribute("d",pathD);	
     }
    //抬起
    elementSvg.onmouseup=function(event){
    	//抬起的时候储存新的数据
     	elementSvg.onmousemove=null;
        elementSvg.onmouseup=null;
	    //console.log(rectArr,nodeRect,newArr,currentPath,'jjjjjjjjj')
    }
	
}
//清除页面中的全部的rect方块；
function clearRect(svg){
  var g=svg.getElementsByTagName("g");
  for(var i=0;i<g.length;i++){
  	var addG=g[i];
    var childRect=g[i].getElementsByTagName("rect");
    if(childRect.length>=4){
      svg.removeChild(g[i]);
    }
  }
}
//清除单个path的方块包裹,传path对象
function removeRect(path){
  if(path){
    var gParent=path.parentNode;
    var rectParent=gParent.nextElementSibling
    rectParent.parentNode.removeChild(rectParent);
    return true;
  }else{
    return false;
  }
}
//清除高亮的path对象；

//判断点击的path对象是否存在rect方块,确保生成一次,传path[]对象；
function createRcetFleg(nodePath){
  var parentG=nodePath.parentNode;
  var nodeNextG=parentG.nextElementSibling;
  var fleg=true;
  if(nodeNextG){
    var rectChild=nodeNextG.getElementsByTagName('rect');
    if(rectChild.length>0){
      fleg= false;
    }else{
      fleg= true;
    }
  }else{
    fleg= true;
  }
  return fleg;
}
//获取方块的坐标；
function getXY(node){
  var x=node.getAttribute("x");
  var y=node.getAttribute("y");
  return {
    "x":x,
    "y":y
  }
}

//设置方块的坐标；
function setXY(node,x,y){
  node.setAttribute("x",x);
  node.setAttribute("y",y);
}

function getDfn(obj){
	var d=obj.getAttribute("d");
	var arr=d.split(/\s+/);  
	var newArr=[];    
    for(var i=0;i<arr.length;i++){
      newArr.push(arr[i].replace(/[a-z]+/ig,""));
    }
    newArr.splice(newArr.length-1,1)
   return newArr;
}
function runAsync(url){
　　var def = $.Deferred();
　　//做一些异步操作
　　$.ajax({
        type:"get",
        async:false,
        url:url,
        dataType:"json",
        success:function(data){
        	def.resolve(data);
        }
    })
　　return def.promise(); //返回的deferred对象
}
function bindEvent(obj,type,handler){
    if (window.addEventListener) {// 标准浏览器    
      obj.addEventListener(type, handler, false);     
    } else if (window.attachEvent) {// IE浏览器      
      obj.attachEvent("on" + type, handler);
    }
}
 // 事件解除
function removeEvent(elem,type,handler){
    if (window.removeEventListener) {// 标准浏览器      
      elem.removeEventListener(type, handler, false);       
    } else if (window.detachEvent) {// IE浏览器
      elem.detachEvent("on" + type, handler);    
    }
}
	
function getChildrenIndex(ele){ 
	//IE is simplest and fastest 
	if(ele.sourceIndex){ 
		return ele.sourceIndex - ele.parentNode.sourceIndex - 1; 
	} 
	//other browsers 
	var i=0; 
	while(ele = ele.previousElementSibling){ 
		i++; 
	} 
	return i; 
} 
function sortId(a,b){  
   return a.id-b.id  
}
/* 阻止事件冒泡 */
function preventBubble(event){ //取消事件冒泡
    var e=arguments.callee.caller.arguments[0]||event; //若省略此句，下面的e改为event，IE运行可以，但是其他浏览器就不兼容  
    if (e && e.stopPropagation) {  
      e.stopPropagation();  
    } else if (event) {  
      event.cancelBubble = true;  
    }  
}	
function setZoom(elementSvg,precontNum){
	getAllPath(elementSvg);//首次获取所有的path
	var pathAll=elementSvg.getElementsByTagName('path');
	console.log(pathAllSize.length,pathAll.length);
	for(var i=0;i<pathAll.length;i++){
		var pathD=pathAll[i];
		//var arrD=getDfn(pathAll[i]);
		var arrD=pathAllSize[i];
		var strD='M';
		for(var j=0;j<arrD.length/2;j++){
			odd=arrD[j*2]*precontNum;
			even=arrD[j*2+1]*precontNum;
			if(j==0){
				strD+=odd+' '+even+' ';
			}else{
				strD+="L"+odd+' '+even+' ';
			};
		};
		pathD.setAttribute('d',strD);
	};	
}

function getAllPath(elementSvg){
	console.log(pathAllSize,'pppppppppppppppp')
	if(pathAllSize.length==0){
		var pathAll=elementSvg.getElementsByTagName('path');
		for(var i=0;i<pathAll.length;i++){
			var arrD=getDfn(pathAll[i]);
			pathAllSize.push(arrD);
		};	
	};
	
}

</script>
</html>